<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dashboard - Pseudosapiens</title>
    <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
    <meta
      name="description"
      content="Tu dashboard personal de frases motivacionales"
    />

    <!-- Izipay JavaScript SDK - CARGADO DINÁMICAMENTE -->
    <!-- Se cargará solo cuando sea necesario para pagos -->

    <style>
      :root {
        color-scheme: light dark;
        --primary-color: #6366f1;
        --success-color: #10b981;
        --warning-color: #f59e0b;
        --danger-color: #ef4444;
        --bg-primary: #fff;
        --bg-secondary: #f8fafc;
        --text-primary: #111;
        --text-secondary: #64748b;
        --border-color: #e2e8f0;
      }

      @media (prefers-color-scheme: dark) {
        :root {
          --bg-primary: #0f172a;
          --bg-secondary: #1e293b;
          --text-primary: #f1f5f9;
          --text-secondary: #94a3b8;
          --border-color: #334155;
        }
      }

      * {
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial,
          sans-serif;
        margin: 0;
        padding: 0;
        background: var(--bg-secondary);
        color: var(--text-primary);
        line-height: 1.6;
      }

      /* Header */
      .header {
        background: var(--bg-primary);
        border-bottom: 1px solid var(--border-color);
        padding: 1rem 2rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 1.25rem;
        font-weight: 600;
        text-decoration: none;
        color: var(--text-primary);
      }

      .user-info {
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border: 2px solid var(--border-color);
      }

      .user-name {
        font-weight: 500;
      }

      .logout-btn {
        background: none;
        border: 1px solid var(--border-color);
        color: var(--text-secondary);
        padding: 0.5rem 1rem;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.875rem;
        transition: all 0.2s;
      }

      .logout-btn:hover {
        background: var(--bg-secondary);
        border-color: var(--primary-color);
      }

      /* Main Container */
      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 2rem;
      }

      /* Dashboard Grid */
      .dashboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin-bottom: 2rem;
      }

      /* Cards */
      .card {
        background: var(--bg-primary);
        border: 1px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .card-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
      }

      .card-title {
        font-size: 1.125rem;
        font-weight: 600;
        margin: 0;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      /* Stats */
      .stat-number {
        font-size: 2rem;
        font-weight: 700;
        color: var(--primary-color);
        margin: 0.5rem 0;
      }

      .stat-label {
        color: var(--text-secondary);
        font-size: 0.875rem;
      }

      /* Plan Status */
      .plan-status {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        margin: 1rem 0;
      }

      .plan-free {
        background: rgba(156, 163, 175, 0.1);
        color: #6b7280;
      }

      .plan-premium {
        background: rgba(99, 102, 241, 0.1);
        color: var(--primary-color);
      }

      /* Buttons */
      .btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        cursor: pointer;
        text-decoration: none;
        transition: all 0.2s;
        text-align: center;
        justify-content: center;
      }

      .btn-primary {
        background: var(--primary-color);
        color: white;
      }

      .btn-primary:hover {
        background: #4f46e5;
      }

      .btn-secondary {
        background: var(--bg-secondary);
        color: var(--text-primary);
        border: 1px solid var(--border-color);
      }

      .btn-secondary:hover {
        background: var(--border-color);
      }

      .btn-danger {
        background: var(--danger-color);
        color: white;
      }

      .btn-danger:hover {
        background: #dc2626;
      }

      /* Progress Bar */
      .progress-bar {
        width: 100%;
        height: 8px;
        background: var(--bg-secondary);
        border-radius: 4px;
        overflow: hidden;
        margin: 1rem 0;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--success-color)
        );
        border-radius: 4px;
        transition: width 0.3s ease;
      }

      /* Recent Activity */
      .activity-list {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .activity-item {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.75rem 0;
        border-bottom: 1px solid var(--border-color);
      }

      .activity-item:last-child {
        border-bottom: none;
      }

      .activity-icon {
        width: 32px;
        height: 32px;
        background: var(--bg-secondary);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
      }

      .activity-content {
        flex: 1;
      }

      .activity-text {
        margin: 0;
        font-size: 0.875rem;
      }

      .activity-time {
        color: var(--text-secondary);
        font-size: 0.75rem;
      }

      /* Loading States */
      .loading {
        opacity: 0.6;
        pointer-events: none;
      }

      .skeleton {
        background: linear-gradient(
          90deg,
          var(--bg-secondary) 25%,
          transparent 50%,
          var(--bg-secondary) 75%
        );
        background-size: 200% 100%;
        animation: loading 1.5s infinite;
      }

      @keyframes loading {
        0% {
          background-position: 200% 0;
        }
        100% {
          background-position: -200% 0;
        }
      }

      /* Responsive */
      @media (max-width: 768px) {
        .header {
          padding: 1rem;
          flex-direction: column;
          gap: 1rem;
          text-align: center;
        }

        .container {
          padding: 1rem;
        }

        .dashboard-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .card {
          padding: 1rem;
        }

        .user-info {
          flex-direction: column;
          gap: 0.5rem;
        }
      }

      /* Focus states for accessibility */
      .btn:focus,
      .logout-btn:focus {
        outline: 2px solid var(--primary-color);
        outline-offset: 2px;
      }

      /* High contrast mode */
      @media (prefers-contrast: high) {
        .btn:focus,
        .logout-btn:focus {
          outline: 3px solid;
        }
      }

      /* Tabs Navigation */
      .tabs-nav {
        display: flex;
        background: var(--bg-primary);
        border-radius: 12px;
        padding: 0.25rem;
        margin-bottom: 2rem;
        border: 1px solid var(--border-color);
      }

      .tab-btn {
        flex: 1;
        padding: 0.75rem 1rem;
        background: transparent;
        border: none;
        border-radius: 8px;
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-secondary);
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
      }

      .tab-btn.active {
        background: var(--primary-color);
        color: white;
        box-shadow: 0 2px 4px rgba(99, 102, 241, 0.3);
      }

      .tab-btn:hover:not(.active) {
        background: var(--bg-secondary);
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      /* Preferences Form Styles */
      .preferences-form {
        display: grid;
        gap: 1rem;
        margin-top: 1rem;
      }

      .form-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
      }

      .form-label {
        font-size: 0.875rem;
        font-weight: 500;
        color: var(--text-primary);
      }

      .form-input,
      .form-select {
        padding: 0.75rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        font-size: 1rem;
        background: var(--bg-primary);
        color: var(--text-primary);
        transition: border-color 0.2s;
      }

      .form-input:focus,
      .form-select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
      }

      .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
      }

      .premium-option {
        color: #9ca3af !important;
        font-style: italic;
        background: var(--bg-secondary) !important;
      }

      .info-box {
        background: rgba(99, 102, 241, 0.1);
        border: 1px solid var(--primary-color);
        border-radius: 8px;
        padding: 1rem;
        margin: 1rem 0;
        color: var(--text-primary);
      }

      .danger-zone {
        border-top: 1px solid var(--border-color);
        margin-top: 2rem;
        padding-top: 2rem;
      }

      .danger-zone h3 {
        color: var(--danger-color);
        margin: 0 0 1rem 0;
        font-size: 1rem;
      }

      /* Izipay Payment Styles - Inline */
      .payment-plans {
        display: grid;
        gap: 1rem;
        margin: 1.5rem 0;
      }

      .payment-plan {
        border: 2px solid var(--border-color);
        border-radius: 12px;
        padding: 1.5rem;
        transition: all 0.3s ease;
        cursor: pointer;
        background: var(--bg-primary);
      }

      .payment-plan:hover {
        border-color: var(--primary-color);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
      }

      .payment-plan.popular::before {
        content: "🔥 Más Popular";
        position: absolute;
        top: -10px;
        right: 1rem;
        background: var(--success-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .plan-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
      }

      .plan-name {
        font-weight: 600;
        font-size: 1.1rem;
      }

      .plan-price {
        font-weight: 700;
        color: var(--primary-color);
        font-size: 1.2rem;
      }

      .plan-features {
        list-style: none;
        padding: 0;
        margin: 0;
      }

      .plan-features li {
        padding: 0.25rem 0;
        color: var(--text-secondary);
        font-size: 0.9rem;
      }

      /* Nuevos estilos para Izipay */
      .payment-processing {
        text-align: center;
        padding: 3rem;
      }

      .payment-processing .spinner {
        display: inline-block;
        width: 40px;
        height: 40px;
        border: 4px solid var(--border-color);
        border-top: 4px solid var(--primary-color);
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-bottom: 1rem;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      #izipay-form-container {
        margin-top: 2rem;
        padding: 2rem;
        background: var(--bg-primary);
        border-radius: 12px;
        border: 2px solid var(--primary-color);
      }

      #kr-embedded {
        min-height: 400px;
      }

      .kr-embedded {
        padding: 1rem;
      }

      /* Onboarding Overlay */
      .onboarding-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        z-index: 1000;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease-out;
      }

      .onboarding-modal {
        background: var(--bg-primary);
        border-radius: 16px;
        padding: 2rem;
        max-width: 500px;
        width: 90vw;
        text-align: center;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        animation: slideIn 0.3s ease-out;
      }

      .onboarding-step {
        display: none;
      }

      .onboarding-step.active {
        display: block;
      }

      .onboarding-progress {
        display: flex;
        justify-content: center;
        gap: 0.5rem;
        margin-bottom: 2rem;
      }

      .progress-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: var(--border-color);
        transition: all 0.3s;
      }

      .progress-dot.active {
        background: var(--primary-color);
      }

      .onboarding-title {
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: var(--text-primary);
      }

      .onboarding-description {
        color: var(--text-secondary);
        margin-bottom: 2rem;
        line-height: 1.6;
      }

      .onboarding-actions {
        display: flex;
        gap: 1rem;
        justify-content: center;
        flex-wrap: wrap;
      }

      .phrase-preview {
        background: var(--bg-secondary);
        border-left: 4px solid var(--primary-color);
        padding: 1.5rem;
        margin: 1rem 0;
        border-radius: 8px;
        font-style: italic;
        color: var(--text-primary);
      }

      .phrase-preview .author {
        margin-top: 1rem;
        font-weight: 600;
        color: var(--text-secondary);
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      @keyframes slideIn {
        from {
          opacity: 0;
          transform: translateY(-20px) scale(0.95);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .hidden {
        display: none !important;
      }

      /* Error States */
      .error {
        color: var(--danger-color);
        background: rgba(239, 68, 68, 0.1);
        padding: 0.75rem;
        border-radius: 6px;
        margin: 1rem 0;
        font-size: 0.875rem;
      }

      /* Success States */
      .success {
        color: var(--success-color);
        background: rgba(16, 185, 129, 0.1);
        padding: 0.75rem;
        border-radius: 6px;
        margin: 1rem 0;
        font-size: 0.875rem;
      }

      /* Override Izipay default styles */
      .kr-embedded iframe {
        border-radius: 8px !important;
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <header class="header">
      <a href="#" class="logo"> 💭 Pseudosapiens </a>

      <div class="user-info" id="userInfo">
        <img
          id="userAvatar"
          class="user-avatar"
          src=""
          alt="Avatar"
          style="display: none"
        />
        <span id="userName" class="user-name">Cargando...</span>
        <button class="logout-btn" onclick="logout()">Cerrar Sesión</button>
      </div>
    </header>

    <!-- Main Container -->
    <main class="container">
      <!-- Tabs Navigation -->
      <nav class="tabs-nav">
        <button class="tab-btn active" onclick="showTab('overview')">
          🏠 Inicio
        </button>
        <button class="tab-btn" onclick="showTab('preferences')">
          ⚙️ Preferencias
        </button>
        <button class="tab-btn" onclick="showTab('stats')">
          📊 Estadísticas
        </button>
      </nav>

      <!-- Overview Tab (Default Dashboard) -->
      <div id="tab-overview" class="tab-content active">
        <div class="dashboard-grid">
          <!-- Estadísticas de Uso -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">📊 Tus Estadísticas</h2>
            </div>
            <div class="stat-number" id="totalPhrases">-</div>
            <p class="stat-label">Frases motivacionales recibidas</p>

            <div class="progress-bar">
              <div
                class="progress-fill"
                id="progressFill"
                style="width: 0%"
              ></div>
            </div>
            <p class="stat-label">Progreso este mes</p>
          </div>

          <!-- Plan Actual -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">💳 Tu Plan</h2>
            </div>
            <div id="planStatus" class="plan-status plan-free">
              <span>📦</span>
              <span>Plan Gratuito</span>
            </div>
            <p class="stat-label" id="planDescription">
              3 frases por semana (L-M-V a las 8:00)
            </p>

            <div id="subscriptionActions">
              <button class="btn btn-primary" onclick="upgradeToPremium()">
                🚀 Upgrade a Premium
              </button>
            </div>

            <!-- Payment Plans Container -->
            <div
              id="payment-plans-container"
              style="display: none; margin-top: 2rem"
            >
              <!-- Plans will be loaded here dynamically -->
            </div>
          </div>

          <!-- Configuración -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">⚙️ Configuración</h2>
            </div>
            <p>
              <strong>Frecuencia:</strong>
              <span id="currentFrequency">3 por semana</span>
            </p>
            <p>
              <strong>Próxima frase:</strong>
              <span id="nextPhrase">Mañana a las 8:00</span>
            </p>
            <p><strong>Desde:</strong> <span id="memberSince">-</span></p>

            <button class="btn btn-secondary" onclick="showSettings()">
              Modificar Configuración
            </button>
          </div>

          <!-- Actividad Reciente -->
          <div class="card">
            <div class="card-header">
              <h2 class="card-title">📬 Actividad Reciente</h2>
            </div>
            <ul class="activity-list" id="recentActivity">
              <li class="activity-item">
                <div class="activity-icon">💭</div>
                <div class="activity-content">
                  <p class="activity-text">Cargando actividad...</p>
                  <span class="activity-time">-</span>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Preferences Tab -->
      <div id="tab-preferences" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">⚙️ Personaliza tu Experiencia</h2>
          </div>

          <p>
            Cambia la frecuencia de tus frases cuando quieras. Tus nuevas
            preferencias se activarán inmediatamente.
          </p>

          <div class="info-box">
            <strong>¿Cómo funciona?</strong> Solo recibirás emails en tu nueva
            frecuencia elegida. No habrá duplicados. Los cambios son
            instantáneos.
          </div>

          <form id="preferences-form" class="preferences-form">
            <div class="form-group">
              <label class="form-label" for="pref-email"
                >Correo electrónico</label
              >
              <input
                id="pref-email"
                name="email"
                type="email"
                class="form-input"
                placeholder="tu@email.com"
                required
                readonly
              />
            </div>

            <div class="form-group">
              <label class="form-label" for="pref-frequency"
                >Elige tu nueva frecuencia</label
              >
              <select
                id="pref-frequency"
                name="frequency"
                class="form-select"
                required
              >
                <option value="weekly-3" selected>
                  3/semana (L-M-V, 8:00) - Gratis
                </option>
                <option value="1-daily" class="premium-option" disabled>
                  1 vez al día (24h) [Premium S/5]
                </option>
                <option value="2-daily" class="premium-option" disabled>
                  2 veces al día (12h) [Premium S/10]
                </option>
              </select>
            </div>

            <div class="form-actions">
              <button
                type="submit"
                class="btn btn-primary"
                id="save-preferences"
              >
                💾 Guardar cambios
              </button>
            </div>

            <small
              style="
                color: var(--text-secondary);
                margin-top: 1rem;
                display: block;
              "
            >
              Los cambios son instantáneos. Tu próximo email seguirá la nueva
              frecuencia.
            </small>

            <!-- Status messages -->
            <div id="pref-status-message" style="margin-top: 1rem"></div>
          </form>

          <!-- Danger Zone -->
          <div class="danger-zone">
            <h3>🚨 Zona Peligrosa</h3>
            <p style="color: var(--text-secondary); margin-bottom: 1rem">
              Esta acción no se puede deshacer.
            </p>
            <button class="btn btn-danger" onclick="unsubscribeFromDashboard()">
              🗑️ Desuscribirse Completamente
            </button>
          </div>
        </div>
      </div>

      <!-- Statistics Tab -->
      <div id="tab-stats" class="tab-content">
        <div class="card">
          <div class="card-header">
            <h2 class="card-title">📊 Estadísticas Detalladas</h2>
          </div>

          <div class="dashboard-grid">
            <div class="card">
              <h3>📈 Este Mes</h3>
              <div class="stat-number" id="stats-month">-</div>
              <p class="stat-label">Frases recibidas en el mes actual</p>
            </div>

            <div class="card">
              <h3>🎯 Total Histórico</h3>
              <div class="stat-number" id="stats-total">-</div>
              <p class="stat-label">Total de frases desde que te uniste</p>
            </div>

            <div class="card">
              <h3>📅 Días Activo</h3>
              <div class="stat-number" id="stats-days">-</div>
              <p class="stat-label">Días desde tu registro</p>
            </div>

            <div class="card">
              <h3>⭐ Plan Actual</h3>
              <div class="stat-number" id="stats-plan">Gratuito</div>
              <p class="stat-label">Tu suscripción actual</p>
            </div>
          </div>

          <div class="info-box" style="margin-top: 2rem">
            <strong>💡 ¿Sabías que?</strong> Los usuarios Premium reciben hasta
            4 frases motivacionales personalizadas por día, adaptadas a
            diferentes momentos del día para máximo impacto.
          </div>
        </div>
      </div>
    </main>

    <!-- Onboarding Overlay -->
    <div id="onboarding-overlay" class="onboarding-overlay hidden">
      <div class="onboarding-modal">
        <!-- Progress Dots -->
        <div class="onboarding-progress">
          <div class="progress-dot active"></div>
          <div class="progress-dot"></div>
          <div class="progress-dot"></div>
        </div>

        <!-- Step 1: Welcome -->
        <div id="onboarding-step-1" class="onboarding-step active">
          <h2 class="onboarding-title">¡Bienvenido a Pseudosapiens! 🎯</h2>
          <p class="onboarding-description">
            Te damos la bienvenida a tu plataforma personal de frases
            motivacionales. Aquí podrás personalizar completamente tu
            experiencia y ver todas tus estadísticas.
          </p>
          <div class="onboarding-actions">
            <button class="btn btn-primary" onclick="nextOnboardingStep()">
              Comenzar Tour 🚀
            </button>
            <button class="btn btn-secondary" onclick="skipOnboarding()">
              Omitir
            </button>
          </div>
        </div>

        <!-- Step 2: Features -->
        <div id="onboarding-step-2" class="onboarding-step">
          <h2 class="onboarding-title">Personaliza tu Experiencia ⚙️</h2>
          <p class="onboarding-description">
            Desde la pestaña <strong>"Preferencias"</strong> podrás cambiar la
            frecuencia de tus frases, desde 3 por semana (gratuito) hasta planes
            premium con frases diarias personalizadas.
          </p>
          <div class="onboarding-actions">
            <button class="btn btn-primary" onclick="nextOnboardingStep()">
              Continuar
            </button>
            <button class="btn btn-secondary" onclick="prevOnboardingStep()">
              Atrás
            </button>
          </div>
        </div>

        <!-- Step 3: Preview -->
        <div id="onboarding-step-3" class="onboarding-step">
          <h2 class="onboarding-title">Ejemplo de Frase Motivacional ✨</h2>
          <p class="onboarding-description">
            Este es el tipo de contenido personalizado que recibirás en tu
            email:
          </p>
          <div class="phrase-preview">
            <div>
              "El éxito no es la clave de la felicidad. La felicidad es la clave
              del éxito. Si amas lo que haces, tendrás éxito."
            </div>
            <div class="author">— Albert Schweitzer</div>
          </div>
          <p
            style="
              font-size: 0.875rem;
              color: var(--text-secondary);
              margin-bottom: 2rem;
            "
          >
            Cada frase incluye un asunto único generado por IA y está optimizada
            para el mejor momento del día.
          </p>
          <div class="onboarding-actions">
            <button class="btn btn-primary" onclick="finishOnboarding()">
              ¡Perfecto, empecemos! 🎉
            </button>
            <button class="btn btn-secondary" onclick="prevOnboardingStep()">
              Atrás
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      // Variables globales para Izipay
      let izipayLoaded = false;
      let currentFormToken = null;
      let currentPublicKey = null;

      // Función para cargar el SDK de Izipay dinámicamente
      function loadIzipaySDK(publicKey) {
        return new Promise((resolve, reject) => {
          if (izipayLoaded) {
            resolve();
            return;
          }

          const script = document.createElement('script');
          script.src = 'https://static.micuentaweb.pe/static/js/krypton-client/V4.0/stable/kr-payment-form.min.js';
          script.setAttribute('kr-public-key', publicKey);
          script.onload = () => {
            izipayLoaded = true;
            console.log('Izipay SDK loaded successfully');
            resolve();
          };
          script.onerror = () => {
            console.error('Failed to load Izipay SDK');
            reject(new Error('Failed to load Izipay SDK'));
          };
          document.head.appendChild(script);

          // También cargar estilos de Izipay
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = 'https://static.micuentaweb.pe/static/js/krypton-client/V4.0/stable/kr-payment-form.min.css';
          document.head.appendChild(link);
        });
      }

      // Global state
      let currentUser = null;
      let userSubscription = null;

      // Onboarding state
      let currentOnboardingStep = 1;
      let isFirstVisit = false;

      // Check authentication on page load
      document.addEventListener("DOMContentLoaded", function () {
        checkAuthentication();
      });

      function checkAuthentication() {
        // Check if user data exists in localStorage (from Google Sign-In)
        const userData = localStorage.getItem("pseudosapiens_user");

        if (!userData) {
          // No user data found, redirect to landing page
          window.location.href = "/";
          return;
        }

        try {
          currentUser = JSON.parse(userData);
          initializeDashboard();
        } catch (e) {
          console.error("Error parsing user data:", e);
          window.location.href = "/";
        }
      }

      function initializeDashboard() {
        if (!currentUser) return;

        // Check if this is first visit
        checkFirstVisit();

        // Update user info in header
        updateUserInfo();

        // Load user statistics and subscription data
        loadDashboardData();

        // Check URL parameters for tab navigation
        checkInitialTab();
      }

      function checkFirstVisit() {
        const hasVisited = localStorage.getItem("pseudosapiens_visited");

        if (!hasVisited) {
          isFirstVisit = true;
          localStorage.setItem("pseudosapiens_visited", "true");

          // Show onboarding after a short delay to let dashboard load
          setTimeout(showOnboarding, 1500);
        }
      }

      function showOnboarding() {
        const overlay = document.getElementById("onboarding-overlay");
        overlay.classList.remove("hidden");

        // Reset to first step
        currentOnboardingStep = 1;
        updateOnboardingStep();
      }

      function nextOnboardingStep() {
        if (currentOnboardingStep < 3) {
          currentOnboardingStep++;
          updateOnboardingStep();
        }
      }

      function prevOnboardingStep() {
        if (currentOnboardingStep > 1) {
          currentOnboardingStep--;
          updateOnboardingStep();
        }
      }

      function updateOnboardingStep() {
        // Hide all steps
        document.querySelectorAll(".onboarding-step").forEach((step) => {
          step.classList.remove("active");
        });

        // Show current step
        document
          .getElementById(`onboarding-step-${currentOnboardingStep}`)
          .classList.add("active");

        // Update progress dots
        document.querySelectorAll(".progress-dot").forEach((dot, index) => {
          if (index < currentOnboardingStep) {
            dot.classList.add("active");
          } else {
            dot.classList.remove("active");
          }
        });
      }

      function finishOnboarding() {
        const overlay = document.getElementById("onboarding-overlay");
        overlay.classList.add("hidden");

        // Show welcome message
        showSuccess(
          "¡Bienvenido a Pseudosapiens! Tu experiencia personalizada ha comenzado 🎆"
        );

        // Optional: Open preferences tab to encourage user to customize
        setTimeout(() => {
          const preferencesBtn = document.querySelector(
            ".tab-btn[onclick=\"showTab('preferences')\"]"
          );
          if (preferencesBtn) {
            preferencesBtn.click();
          }
        }, 2000);
      }

      function skipOnboarding() {
        if (
          confirm(
            "¿Estás seguro que deseas omitir el tour? Siempre puedes explorarlo por tu cuenta."
          )
        ) {
          finishOnboarding();
        }
      }

      function updateUserInfo() {
        const userNameEl = document.getElementById("userName");
        const userAvatarEl = document.getElementById("userAvatar");

        if (currentUser.name) {
          userNameEl.textContent = currentUser.name;
        } else {
          userNameEl.textContent = currentUser.email;
        }

        if (currentUser.avatar_url) {
          userAvatarEl.src = currentUser.avatar_url;
          userAvatarEl.style.display = "block";
        }
      }

      async function loadDashboardData() {
        try {
          // Load user statistics
          await Promise.all([loadUserStats(), loadUserSubscription()]);

          // Load recent activity with real data (will be called after subscription loads)
        } catch (error) {
          console.error("Error loading dashboard data:", error);
          showError("Error cargando datos del dashboard");
        }
      }

      async function loadUserStats() {
        try {
          // This will be loaded from loadUserSubscription which includes stats
          // Keep this function for now but stats will come from the subscription API
        } catch (error) {
          console.error("Error loading user stats:", error);
        }
      }

      async function loadUserSubscription() {
        try {
          // Check current subscription status
          const response = await fetch(
            "https://elias-webhook.vercel.app/webhook/user-subscription",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: currentUser.email,
              }),
            }
          );

          if (response.ok) {
            const data = await response.json();
            updateSubscriptionUI(data);
            updateUserStatsUI(data.user_stats);
            loadRecentActivity(data.user_stats, data);
          } else {
            // Default to free plan
            const defaultData = { plan_id: 0 };
            const defaultStats = {
              total_emails_sent: 0,
              last_email_sent_at: null,
              member_since: null,
            };
            updateSubscriptionUI(defaultData);
            updateUserStatsUI(defaultStats);
            loadRecentActivity(defaultStats, defaultData);
          }
        } catch (error) {
          console.error("Error loading subscription:", error);
          const defaultData = { plan_id: 0 };
          const defaultStats = {
            total_emails_sent: 0,
            last_email_sent_at: null,
            member_since: null,
          };
          updateSubscriptionUI(defaultData);
          updateUserStatsUI(defaultStats);
          loadRecentActivity(defaultStats, defaultData);
        }
      }

      function updateUserStatsUI(userStats) {
        if (!userStats) return;

        // Update total phrases count
        const totalPhrases = userStats.total_emails_sent || 0;
        document.getElementById("totalPhrases").textContent = totalPhrases;

        // Calculate progress (let's say 30 phrases per month as a goal)
        const monthlyGoal = 30;
        const progressPercent = Math.min(
          ((totalPhrases % monthlyGoal) / monthlyGoal) * 100,
          100
        );
        document.getElementById("progressFill").style.width =
          progressPercent + "%";

        // Update member since date
        if (userStats.member_since) {
          const memberDate = new Date(userStats.member_since);
          document.getElementById("memberSince").textContent =
            memberDate.toLocaleDateString("es-ES");
        }

        // Don't update next phrase here - it will be updated by subscription data
      }

      function updateSubscriptionUI(subscriptionData) {
        const planStatus = document.getElementById("planStatus");
        const planDescription = document.getElementById("planDescription");
        const subscriptionActions = document.getElementById(
          "subscriptionActions"
        );
        const currentFrequency = document.getElementById("currentFrequency");

        switch (subscriptionData.plan_id) {
          case 0:
            planStatus.innerHTML = "<span>📦</span><span>Plan Gratuito</span>";
            planStatus.className = "plan-status plan-free";
            planDescription.textContent =
              "3 frases por semana (L-M-V a las 8:00)";
            currentFrequency.textContent = "3 por semana";
            subscriptionActions.innerHTML = `
                        <button class="btn btn-primary" onclick="upgradeToPremium()">
                            🚀 Upgrade a Premium - Desde S/ 5.00/mes
                        </button>
                    `;
            break;
          case 1:
          case 2:
          case 3:
          case 4:
            planStatus.innerHTML = "<span>⭐</span><span>Plan Premium</span>";
            planStatus.className = "plan-status plan-premium";
            // Actualizar descripción del plan con lógica jerárquica
            if (subscriptionData.plan_id === 1) {
              planDescription.textContent = `1 frase al día - S/ 5.00/mes`;
            } else if (subscriptionData.plan_id === 2) {
              planDescription.textContent = `2 frases al día (incluye Plan Básico) - S/ 10.00/mes`;
            } else {
              planDescription.textContent = `${subscriptionData.plan_id} frases al día - Plan personalizado`;
            }
            currentFrequency.textContent = `${subscriptionData.plan_id} por día`;
            subscriptionActions.innerHTML = `
                        <button class="btn btn-secondary" onclick="managePremium()">
                            ⚙️ Gestionar Suscripción
                        </button>
                        <button class="btn btn-danger" onclick="cancelSubscription()">
                            ❌ Cancelar Premium
                        </button>
                    `;
            break;
          default:
            planStatus.innerHTML =
              "<span>❓</span><span>Plan Desconocido</span>";
        }

        userSubscription = subscriptionData;
      }

      function loadRecentActivity(userStats, subscriptionData) {
        try {
          const activities = [];

          // Add last email sent activity if available
          if (userStats && userStats.last_email_sent_at) {
            const lastSent = new Date(userStats.last_email_sent_at);
            const timeAgo = getTimeAgo(lastSent);
            activities.push({
              icon: "💭",
              text: "Frase motivacional enviada",
              time: timeAgo,
            });
          }

          // Add subscription activity if premium
          if (subscriptionData && subscriptionData.plan_id > 0) {
            activities.push({
              icon: "⭐",
              text: "Upgrade a Premium",
              time: "Reciente",
            });
          }

          // Add member since activity
          if (userStats && userStats.member_since) {
            const memberDate = new Date(userStats.member_since);
            const timeAgo = getTimeAgo(memberDate);
            activities.push({
              icon: "✨",
              text: "Te uniste a Pseudosapiens",
              time: timeAgo,
            });
          }

          // If no activities, show default
          if (activities.length === 0) {
            activities.push({
              icon: "🎯",
              text: "Dashboard configurado",
              time: "Ahora",
            });
          }

          const activityList = document.getElementById("recentActivity");
          activityList.innerHTML = activities
            .map(
              (activity) => `
                    <li class="activity-item">
                        <div class="activity-icon">${activity.icon}</div>
                        <div class="activity-content">
                            <p class="activity-text">${activity.text}</p>
                            <span class="activity-time">${activity.time}</span>
                        </div>
                    </li>
                `
            )
            .join("");
        } catch (error) {
          console.error("Error loading recent activity:", error);
          // Fallback to simple message
          document.getElementById("recentActivity").innerHTML = `
                    <li class="activity-item">
                        <div class="activity-icon">📊</div>
                        <div class="activity-content">
                            <p class="activity-text">Dashboard cargado</p>
                            <span class="activity-time">Ahora</span>
                        </div>
                    </li>
                `;
        }
      }

      function getTimeAgo(date) {
        const now = new Date();
        const diffMs = now - date;
        const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));

        if (diffDays === 0) {
          return "Hoy";
        } else if (diffDays === 1) {
          return "Ayer";
        } else if (diffDays < 7) {
          return `Hace ${diffDays} días`;
        } else if (diffDays < 30) {
          const weeks = Math.floor(diffDays / 7);
          return `Hace ${weeks} semana${weeks > 1 ? "s" : ""}`;
        } else {
          const months = Math.floor(diffDays / 30);
          return `Hace ${months} mes${months > 1 ? "es" : ""}`;
        }
      }

      function showNextPhrase() {
        // Calculate next phrase time based on plan
        const now = new Date();
        const tomorrow = new Date(now);
        tomorrow.setDate(now.getDate() + 1);
        tomorrow.setHours(8, 0, 0, 0);

        document.getElementById("nextPhrase").textContent =
          tomorrow.toLocaleString("es-ES", {
            weekday: "long",
            hour: "2-digit",
            minute: "2-digit",
          });
      }

      async function upgradeToPremium() {
        if (!currentUser) return;

        // Mostrar selector de planes de pago Izipay
        showPaymentPlans();
      }

      function showPaymentPlans() {
        const container = document.getElementById("payment-plans-container");
        if (!container) return;

        // Planes disponibles - Solo Plan 1 y 2 activos (Sept 2025)
        const plans = [
          {
            id: 1,
            name: 'Premium Básico',
            price: 5.00,
            emails: 1,
            features: [
              '1 frase motivacional diaria',
              'Enviada a las 8:00 AM',
              'Sin publicidad',
              'Soporte prioritario'
            ]
          },
          {
            id: 2,
            name: 'Premium Plus',
            price: 10.00,
            emails: 2,
            features: [
              '2 frases motivacionales diarias',
              'Enviadas a las 8:00 AM y 5:00 PM',
              'Incluye todas las ventajas del Plan Básico',
              'Frases exclusivas premium',
              'Soporte VIP'
            ],
            popular: true
          }
        ];

        container.innerHTML = `
          <h3 style="text-align: center; margin-bottom: 1.5rem; color: var(--primary-color);">
            🚀 Selecciona tu Plan Premium
          </h3>
          <div class="payment-plans">
            ${plans.map(plan => `
              <div class="payment-plan ${plan.popular ? 'popular' : ''}" 
                   onclick="selectPlan(${plan.id}, '${plan.name}', ${plan.price})"
                   style="position: relative;">
                ${plan.popular ? '<span style="position: absolute; top: -10px; right: 1rem; background: var(--success-color); color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;">🔥 Más Popular</span>' : ''}
                <div class="plan-header">
                  <div class="plan-name">${plan.name}</div>
                  <div class="plan-price">
                    S/ ${plan.price.toFixed(2)}
                    <span style="font-size: 0.8rem; color: var(--text-secondary);">/mes</span>
                  </div>
                </div>
                <ul class="plan-features">
                  ${plan.features.map(feature => `<li>✓ ${feature}</li>`).join('')}
                </ul>
                <div style="text-align: center; margin-top: 1rem;">
                  <button class="btn btn-primary" style="width: 100%;">
                    Seleccionar Plan
                  </button>
                </div>
              </div>
            `).join('')}
          </div>
          <div style="text-align: center; margin-top: 2rem;">
            <button class="btn btn-secondary" onclick="hidePaymentPlans()">
              Cancelar
            </button>
          </div>
          <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
            <span style="color: var(--success-color);">
              🔒 Pago 100% seguro procesado por Izipay<br>
              <small>Acepta todas las tarjetas de crédito y débito</small>
            </span>
          </div>
        `;

        container.style.display = "block";
      }

      function hidePaymentPlans() {
        const container = document.getElementById("payment-plans-container");
        if (container) {
          container.style.display = "none";
        }
      }

      // Función mejorada para seleccionar plan
      async function selectPlan(planId, planName, planPrice) {
        if (!currentUser) return;

        if (!confirm(
          `¿Confirmas la suscripción a ${planName} por S/ ${planPrice.toFixed(2)}/mes?\n\n` +
          `Se abrirá el formulario de pago seguro de Izipay.`
        )) {
          return;
        }

        // Mostrar loading
        const container = document.getElementById('payment-plans-container');
        container.innerHTML = `
          <div class="payment-processing">
            <div class="spinner"></div>
            <h3>Preparando formulario de pago...</h3>
            <p style="color: var(--text-secondary);">Conectando con Izipay de forma segura</p>
          </div>
        `;

        try {
          // Llamar a la función de Netlify para crear el token
          console.log('Creating payment token for plan:', planId);
          
          const response = await fetch('/.netlify/functions/create_payment', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              user_email: currentUser.email,
              plan_id: planId
            })
          });

          const result = await response.json();
          console.log('Payment API response:', result);

          if (result.status === 'success' && result.data) {
            const { form_token, public_key, order_id, amount, js_url } = result.data;
            
            // Guardar para uso posterior
            currentFormToken = form_token;
            currentPublicKey = public_key;

            // Cargar SDK de Izipay si no está cargado
            await loadIzipaySDK(public_key);

            // Mostrar formulario de pago Izipay
            container.innerHTML = `
              <div id="izipay-form-container">
                <h3 style="text-align: center; margin-bottom: 1.5rem;">
                  💳 Completa tu Pago
                </h3>
                <p style="text-align: center; margin-bottom: 2rem; color: var(--text-secondary);">
                  Plan: <strong>${planName}</strong> - S/ ${(amount/100).toFixed(2)}/mes<br>
                  <small>Order ID: ${order_id}</small>
                </p>
                
                <!-- Contenedor del formulario Izipay -->
                <div id="kr-embedded">
                  <div class="kr-embedded" kr-form-token="${form_token}"></div>
                </div>
                
                <div style="text-align: center; margin-top: 2rem;">
                  <button class="btn btn-secondary" onclick="cancelPayment()">
                    Cancelar
                  </button>
                </div>
                
                <div style="text-align: center; margin-top: 1rem; padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px;">
                  <span style="color: var(--success-color);">
                    🔒 Pago 100% seguro procesado por Izipay<br>
                    <small>Tarjeta de prueba: 4970100000000055</small>
                  </span>
                </div>
              </div>
            `;

            // Inicializar formulario Izipay
            if (window.KR) {
              initializeIzipayForm(form_token);
            } else {
              console.error('KR object not available');
              throw new Error('Izipay SDK not loaded properly');
            }

          } else {
            throw new Error(result.message || 'Error creating payment token');
          }

        } catch (error) {
          console.error('Error selecting plan:', error);
          container.innerHTML = `
            <div style="text-align: center; padding: 2rem;">
              <h3 style="color: var(--danger-color);">❌ Error al procesar el pago</h3>
              <p>${error.message}</p>
              <button class="btn btn-primary" onclick="hidePaymentPlans()" style="margin-top: 1rem;">
                Intentar nuevamente
              </button>
            </div>
          `;
        }
      }

      // Función para inicializar el formulario de Izipay
      function initializeIzipayForm(formToken) {
        try {
          console.log('Initializing Izipay form with token:', formToken.substring(0, 20) + '...');

          // Configurar el formulario
          KR.setFormConfig({
            'formToken': formToken,
            'kr-language': 'es-ES'
          });

          // Adjuntar el formulario al contenedor
          KR.attachForm('#kr-embedded').then(({ KR, result }) => {
            console.log('Izipay form attached successfully');
            
            // Manejar el envío del formulario
            KR.onSubmit((paymentData) => {
              console.log('Payment submitted:', paymentData);
              
              // Aquí puedes validar el pago con tu backend
              validatePayment(paymentData);
              
              // Prevenir el envío por defecto
              return false;
            });

            // Manejar errores
            KR.onError((error) => {
              console.error('Izipay error:', error);
              showError('Error en el formulario de pago: ' + error.message);
            });

          }).catch((error) => {
            console.error('Error attaching Izipay form:', error);
            showError('Error al cargar el formulario de pago');
          });

        } catch (error) {
          console.error('Error initializing Izipay:', error);
          showError('Error al inicializar el sistema de pago');
        }
      }

      // Función para validar el pago con el backend
      async function validatePayment(paymentData) {
        try {
          console.log('Validating payment with backend...');
          
          // Llamar al webhook handler para procesar el pago
          const response = await fetch('/.netlify/functions/webhook_handler', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              'kr-answer': paymentData.rawClientAnswer,
              'kr-hash': paymentData.hash,
              'kr-hash-algorithm': 'sha256_hmac'
            })
          });

          if (response.ok) {
            // Pago exitoso
            console.log('Payment validated successfully');
            showSuccess('¡Pago procesado exitosamente! Tu suscripción premium está activa.');
            
            // Recargar datos del dashboard
            setTimeout(() => {
              hidePaymentPlans();
              loadUserSubscription();
            }, 3000);
            
          } else {
            throw new Error('Payment validation failed');
          }

        } catch (error) {
          console.error('Payment validation error:', error);
          showError('Error al procesar el pago. Por favor intenta nuevamente.');
        }
      }

      // Función para cancelar el pago
      function cancelPayment() {
        if (confirm('¿Estás seguro que deseas cancelar el proceso de pago?')) {
          hidePaymentPlans();
        }
      }

      function managePremium() {
        // Show premium management options
        if (confirm("¿Deseas cambiar tu plan premium?")) {
          // Redirect to plan selection or show modal
          showSuccess("Funcionalidad de gestión de planes próximamente.");
        }
      }

      async function cancelSubscription() {
        if (
          !confirm(
            "¿Estás seguro que deseas cancelar tu suscripción premium? Volverás al plan gratuito."
          )
        ) {
          return;
        }

        try {
          const response = await fetch(
            "https://elias-webhook.vercel.app/unsubscribe",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: currentUser.email,
              }),
            }
          );

          const data = await response.json();

          if (data.status === "success") {
            showSuccess(
              "Suscripción cancelada exitosamente. Has vuelto al plan gratuito."
            );
            // Reload subscription data
            setTimeout(() => loadUserSubscription(), 2000);
          } else {
            throw new Error(data.message || "Error canceling subscription");
          }
        } catch (error) {
          console.error("Error canceling subscription:", error);
          showError("Error al cancelar la suscripción. Inténtalo más tarde.");
        }
      }

      function showSettings() {
        showSuccess(
          "Panel de configuración próximamente. Podrás personalizar horarios y preferencias."
        );
      }

      function logout() {
        // Clear user data
        localStorage.removeItem("pseudosapiens_user");

        // Redirect to landing page
        window.location.href = "/";
      }

      function showError(message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll(".error, .success");
        existingAlerts.forEach((alert) => alert.remove());

        // Create error alert
        const errorDiv = document.createElement("div");
        errorDiv.className = "error";
        errorDiv.textContent = message;

        // Insert at top of container
        const container = document.querySelector(".container");
        container.insertBefore(errorDiv, container.firstChild);

        // Auto-remove after 5 seconds
        setTimeout(() => errorDiv.remove(), 5000);
      }

      function showSuccess(message) {
        // Remove existing alerts
        const existingAlerts = document.querySelectorAll(".error, .success");
        existingAlerts.forEach((alert) => alert.remove());

        // Create success alert
        const successDiv = document.createElement("div");
        successDiv.className = "success";
        successDiv.textContent = message;

        // Insert at top of container
        const container = document.querySelector(".container");
        container.insertBefore(successDiv, container.firstChild);

        // Auto-remove after 5 seconds
        setTimeout(() => successDiv.remove(), 5000);
      }

      // Initialize next phrase calculation
      showNextPhrase();

      // Tab Management Functions
      function showTab(tabName) {
        // Remove active class from all tabs and buttons
        document.querySelectorAll(".tab-content").forEach((tab) => {
          tab.classList.remove("active");
        });
        document.querySelectorAll(".tab-btn").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Show selected tab and activate button
        document.getElementById(`tab-${tabName}`).classList.add("active");
        event.target.classList.add("active");

        // Initialize tab-specific content
        if (tabName === "preferences") {
          initializePreferencesTab();
        } else if (tabName === "stats") {
          initializeStatsTab();
        }
      }

      function initializePreferencesTab() {
        // Pre-fill user email (readonly)
        const emailInput = document.getElementById("pref-email");
        if (currentUser && emailInput) {
          emailInput.value = currentUser.email;
        }

        // Set current frequency based on subscription
        const frequencySelect = document.getElementById("pref-frequency");
        if (userSubscription && frequencySelect) {
          let selectedValue = "weekly-3"; // default

          switch (userSubscription.plan_id) {
            case 0:
              selectedValue = "weekly-3";
              break;
            case 1:
              selectedValue = "1-daily";
              break;
            case 2:
              selectedValue = "2-daily";
              break;
            case 3:
              selectedValue = "3-daily";
              break;
            case 4:
              selectedValue = "4-daily";
              break;
          }

          frequencySelect.value = selectedValue;
        }

        // Setup form handler
        const form = document.getElementById("preferences-form");
        if (form && !form.hasEventListener) {
          form.hasEventListener = true;
          form.addEventListener("submit", handlePreferencesSubmit);

          // Handle premium option clicks
          frequencySelect.addEventListener("change", function (e) {
            const selectedOption = e.target.selectedOptions[0];
            if (
              selectedOption &&
              selectedOption.disabled &&
              selectedOption.classList.contains("premium-option")
            ) {
              // Reset to free option
              frequencySelect.value = "weekly-3";

              // Show premium upgrade message
              showPreferencesMessage(
                "Esta frecuencia requiere Premium. ¡Upgrade disponible desde S/ 5.00!",
                "error"
              );

              setTimeout(() => {
                if (
                  confirm(
                    "¿Te interesa el plan Premium? Te notificaremos cuando esté disponible."
                  )
                ) {
                  upgradeToPremium();
                }
              }, 2000);
            }
          });
        }
      }

      async function handlePreferencesSubmit(e) {
        e.preventDefault();

        const email = document.getElementById("pref-email").value.trim();
        const frequency = document.getElementById("pref-frequency").value;
        const submitBtn = document.getElementById("save-preferences");

        // Validation
        if (!email || !frequency) {
          showPreferencesMessage(
            "Por favor completa todos los campos",
            "error"
          );
          return;
        }

        // Show loading state
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = "🔄 Actualizando...";
        submitBtn.disabled = true;

        try {
          const response = await fetch(
            "https://elias-webhook.vercel.app/webhook/netlify-form",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: email,
                frequency: frequency,
              }),
            }
          );

          const result = await response.json();

          if (response.ok && result.status === "success") {
            const actionText =
              result.action === "updated" ? "actualizadas" : "configuradas";
            showPreferencesMessage(
              `✅ Preferencias ${actionText} correctamente. Los cambios son instantáneos.`,
              "success"
            );

            // Reload subscription data to reflect changes
            setTimeout(() => {
              loadUserSubscription();
            }, 1000);
          } else {
            throw new Error(
              result.message || "Error al actualizar preferencias"
            );
          }
        } catch (error) {
          console.error("Error updating preferences:", error);
          showPreferencesMessage(
            "Error al actualizar preferencias. Por favor inténtalo nuevamente.",
            "error"
          );
        } finally {
          submitBtn.innerHTML = originalText;
          submitBtn.disabled = false;
        }
      }

      function showPreferencesMessage(message, type) {
        const statusDiv = document.getElementById("pref-status-message");
        statusDiv.innerHTML = `<div class="${type}">${message}</div>`;

        // Auto-hide after 5 seconds
        setTimeout(() => {
          statusDiv.innerHTML = "";
        }, 5000);
      }

      async function unsubscribeFromDashboard() {
        if (!currentUser) return;

        if (
          !confirm(
            `¿Estás seguro que quieres cancelar tu suscripción?\n\nEmail: ${currentUser.email}\n\nNo recibirás más frases motivacionales.`
          )
        ) {
          return;
        }

        try {
          const response = await fetch(
            "https://elias-webhook.vercel.app/unsubscribe",
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({
                email: currentUser.email,
              }),
            }
          );

          const data = await response.json();

          if (data.status === "success") {
            showSuccess(
              "Suscripción cancelada exitosamente. Seras redirigido en 3 segundos..."
            );

            setTimeout(() => {
              logout();
            }, 3000);
          } else {
            throw new Error(data.message || "Error canceling subscription");
          }
        } catch (error) {
          console.error("Error canceling subscription:", error);
          showPreferencesMessage(
            "Error al cancelar la suscripción. Inténtalo más tarde.",
            "error"
          );
        }
      }

      function initializeStatsTab() {
        // Update detailed stats
        if (currentUser && userSubscription) {
          // Calculate days since registration
          const memberSinceEl = document.getElementById("memberSince");
          const memberSinceText = memberSinceEl
            ? memberSinceEl.textContent
            : null;

          if (memberSinceText && memberSinceText !== "-") {
            const memberDate = new Date(memberSinceText);
            const today = new Date();
            const diffTime = Math.abs(today - memberDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            document.getElementById("stats-days").textContent = diffDays;
          }

          // Get total phrases from main dashboard
          const totalPhrasesText =
            document.getElementById("totalPhrases").textContent;
          if (totalPhrasesText && totalPhrasesText !== "-") {
            document.getElementById("stats-total").textContent =
              totalPhrasesText;

            // Calculate approximate monthly phrases
            const monthlyEstimate = Math.min(parseInt(totalPhrasesText), 30);
            document.getElementById("stats-month").textContent =
              monthlyEstimate;
          }

          // Update plan name
          const planNames = {
            0: "Gratuito",
            1: "Premium 1x",
            2: "Premium 2x",
            3: "Premium 3x",
            4: "Premium 4x",
          };

          const planName = planNames[userSubscription.plan_id] || "Desconocido";
          document.getElementById("stats-plan").textContent = planName;
        }
      }

      // Manual onboarding trigger (for testing or user request)
      function restartOnboarding() {
        showOnboarding();
      }

      // Check URL parameters for initial tab selection
      function checkInitialTab() {
        const urlParams = new URLSearchParams(window.location.search);
        const requestedTab = urlParams.get("tab");

        if (requestedTab === "preferences") {
          // Auto-open preferences tab
          setTimeout(() => {
            showTab("preferences");
          }, 500);
        } else if (requestedTab === "stats") {
          setTimeout(() => {
            showTab("stats");
          }, 500);
        }
        // Default is 'overview' which is already active
      }
    </script>
  </body>
</html>
